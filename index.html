<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ë¯¸ë˜ì €ë„ â€” AIê°€ ëŒ€ì²´í•  ìˆ˜ ì—†ëŠ” ëŠ¥ë ¥ì„ ë§¤ì¼ í›ˆë ¨í•˜ëŠ” í”Œë«í¼</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@300;400;600;700&family=Noto+Sans+KR:wght@300;400;500;600&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --purple: #7C3AED;
      --indigo: #4F46E5;
      --lavender: #A78BFA;
      --soft-lavender: #C4B5FD;
      --bg: #0F0B1E;
      --bg2: #1A1332;
      --bg3: #231A45;
      --card: #1E1540;
      --card2: #2A1D58;
      --border: rgba(167,139,250,0.18);
      --text: #F3F0FF;
      --text2: #C4B5FD;
      --text3: #9C85D4;
      --success: #34D399;
    }

    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Stars background */
    .stars {
      position: fixed; inset: 0; z-index: 0; pointer-events: none;
      background: radial-gradient(ellipse at 20% 50%, rgba(79,70,229,0.08) 0%, transparent 60%),
                  radial-gradient(ellipse at 80% 20%, rgba(124,58,237,0.06) 0%, transparent 60%);
    }
    .stars::before {
      content: '';
      position: absolute; inset: 0;
      background-image:
        radial-gradient(1px 1px at 10% 15%, rgba(255,255,255,0.6) 0%, transparent 100%),
        radial-gradient(1px 1px at 25% 40%, rgba(255,255,255,0.4) 0%, transparent 100%),
        radial-gradient(1px 1px at 50% 10%, rgba(255,255,255,0.5) 0%, transparent 100%),
        radial-gradient(1px 1px at 70% 60%, rgba(255,255,255,0.3) 0%, transparent 100%),
        radial-gradient(1px 1px at 85% 25%, rgba(255,255,255,0.6) 0%, transparent 100%),
        radial-gradient(1px 1px at 40% 75%, rgba(255,255,255,0.4) 0%, transparent 100%),
        radial-gradient(1px 1px at 90% 80%, rgba(255,255,255,0.5) 0%, transparent 100%),
        radial-gradient(1px 1px at 15% 85%, rgba(255,255,255,0.3) 0%, transparent 100%),
        radial-gradient(1px 1px at 60% 45%, rgba(200,180,255,0.5) 0%, transparent 100%),
        radial-gradient(1px 1px at 35% 25%, rgba(200,180,255,0.4) 0%, transparent 100%);
    }

    /* App layout */
    #app { position: relative; z-index: 1; min-height: 100vh; padding-bottom: 80px; }

    /* Header */
    .header {
      text-align: center;
      padding: 40px 20px 24px;
    }
    .logo {
      font-family: 'Noto Serif KR', serif;
      font-size: 28px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--soft-lavender), var(--lavender), var(--purple));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: -0.5px;
    }
    .logo-sub {
      font-size: 12px;
      color: var(--text3);
      margin-top: 4px;
      letter-spacing: 0.5px;
    }
    .streak-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(124,58,237,0.2);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 6px 14px;
      font-size: 13px;
      color: var(--lavender);
      margin-top: 12px;
    }

    /* Nav tabs */
    .nav {
      display: flex;
      background: var(--card);
      border-top: 1px solid var(--border);
      position: fixed;
      bottom: 0; left: 0; right: 0;
      z-index: 100;
    }
    .nav-btn {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 3px;
      padding: 10px 4px;
      background: none;
      border: none;
      color: var(--text3);
      font-size: 10px;
      font-family: 'Noto Sans KR', sans-serif;
      cursor: pointer;
      transition: color 0.2s;
    }
    .nav-btn.active { color: var(--lavender); }
    .nav-btn svg { width: 22px; height: 22px; }

    /* Pages */
    .page { display: none; padding: 0 16px; }
    .page.active { display: block; }

    /* Today page */
    .date-label {
      text-align: center;
      color: var(--text3);
      font-size: 13px;
      margin-bottom: 20px;
    }
    .greeting {
      font-family: 'Noto Serif KR', serif;
      font-size: 20px;
      font-weight: 600;
      text-align: center;
      color: var(--text);
      margin-bottom: 6px;
    }
    .greeting-sub {
      font-size: 13px;
      color: var(--text3);
      text-align: center;
      margin-bottom: 28px;
    }

    /* Question cards */
    .question-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      transition: border-color 0.2s;
    }
    .question-card.answered { border-color: rgba(167,139,250,0.4); }
    .q-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }
    .q-emoji { font-size: 22px; }
    .q-meta { flex: 1; }
    .q-category { font-size: 11px; color: var(--text3); margin-bottom: 2px; }
    .q-text {
      font-family: 'Noto Serif KR', serif;
      font-size: 15px;
      color: var(--text);
      line-height: 1.6;
    }
    .q-check {
      width: 22px; height: 22px;
      border-radius: 50%;
      background: rgba(52,211,153,0.15);
      border: 1px solid var(--success);
      display: flex; align-items: center; justify-content: center;
      opacity: 0;
      transition: opacity 0.3s;
      flex-shrink: 0;
    }
    .q-check.visible { opacity: 1; }
    .q-check svg { width: 13px; height: 13px; color: var(--success); }

    textarea {
      width: 100%;
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-family: 'Noto Sans KR', sans-serif;
      font-size: 14px;
      line-height: 1.7;
      padding: 12px;
      resize: none;
      min-height: 90px;
      outline: none;
      transition: border-color 0.2s;
    }
    textarea:focus { border-color: var(--lavender); }
    textarea::placeholder { color: var(--text3); }

    .mic-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      background: none;
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text3);
      font-size: 12px;
      font-family: 'Noto Sans KR', sans-serif;
      padding: 6px 12px;
      margin-top: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .mic-btn:hover { color: var(--lavender); border-color: var(--lavender); }
    .mic-btn.recording { color: #F87171; border-color: #F87171; animation: pulse 1s infinite; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }

    .save-btn {
      width: 100%;
      background: linear-gradient(135deg, var(--purple), var(--indigo));
      border: none;
      border-radius: 14px;
      color: white;
      font-family: 'Noto Sans KR', sans-serif;
      font-size: 16px;
      font-weight: 600;
      padding: 16px;
      margin-top: 8px;
      cursor: pointer;
      transition: opacity 0.2s, transform 0.1s;
    }
    .save-btn:hover { opacity: 0.9; }
    .save-btn:active { transform: scale(0.98); }

    /* Progress */
    .progress-bar {
      background: var(--bg3);
      border-radius: 4px;
      height: 4px;
      margin: 0 0 24px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      border-radius: 4px;
      background: linear-gradient(90deg, var(--purple), var(--lavender));
      transition: width 0.4s ease;
    }

    /* Insight page */
    .section-title {
      font-family: 'Noto Serif KR', serif;
      font-size: 18px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 16px;
    }

    .insight-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
    }
    .insight-card h3 {
      font-size: 14px;
      color: var(--text2);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Emotion calendar */
    .cal-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }
    .cal-day {
      aspect-ratio: 1;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: var(--text3);
    }
    .cal-day.has-entry {
      background: linear-gradient(135deg, var(--purple), var(--indigo));
      color: white;
      font-size: 14px;
    }
    .cal-day.today {
      border: 1px solid var(--lavender);
    }

    /* Stats */
    .stats-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 16px;
    }
    .stat-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      text-align: center;
    }
    .stat-num {
      font-family: 'Noto Serif KR', serif;
      font-size: 32px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--soft-lavender), var(--lavender));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .stat-label { font-size: 12px; color: var(--text3); margin-top: 4px; }

    /* Index gauge */
    .gauge-wrap { text-align: center; padding: 8px 0; }
    .gauge-num {
      font-family: 'Noto Serif KR', serif;
      font-size: 48px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--soft-lavender), var(--lavender), var(--purple));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .gauge-label { font-size: 13px; color: var(--text3); margin-top: 4px; }
    .gauge-bar {
      height: 8px;
      background: var(--bg3);
      border-radius: 4px;
      margin: 12px 0 6px;
      overflow: hidden;
    }
    .gauge-fill {
      height: 100%;
      border-radius: 4px;
      background: linear-gradient(90deg, var(--indigo), var(--purple), var(--lavender));
    }

    /* History page */
    .history-item {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 12px;
    }
    .history-date { font-size: 12px; color: var(--text3); margin-bottom: 10px; }
    .history-q { font-size: 12px; color: var(--lavender); margin-bottom: 4px; }
    .history-a { font-size: 14px; color: var(--text); line-height: 1.6; }
    .history-preview {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    /* AI page */
    .ai-chat {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      min-height: 200px;
    }
    .ai-msg {
      background: var(--bg3);
      border-radius: 12px 12px 12px 4px;
      padding: 14px;
      font-size: 14px;
      line-height: 1.7;
      color: var(--text2);
      margin-bottom: 12px;
    }
    .ai-msg-label {
      font-size: 11px;
      color: var(--text3);
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .ai-input-row {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    .ai-input {
      flex: 1;
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-family: 'Noto Sans KR', sans-serif;
      font-size: 14px;
      padding: 10px 14px;
      outline: none;
    }
    .ai-input:focus { border-color: var(--lavender); }
    .ai-send {
      background: linear-gradient(135deg, var(--purple), var(--indigo));
      border: none;
      border-radius: 10px;
      color: white;
      font-size: 18px;
      width: 44px;
      cursor: pointer;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 90px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: var(--card2);
      border: 1px solid var(--lavender);
      border-radius: 12px;
      padding: 12px 20px;
      font-size: 14px;
      color: var(--lavender);
      opacity: 0;
      transition: all 0.3s;
      z-index: 200;
      white-space: nowrap;
    }
    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* Completion banner */
    .completion-banner {
      background: linear-gradient(135deg, rgba(124,58,237,0.3), rgba(79,70,229,0.3));
      border: 1px solid var(--lavender);
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      margin-bottom: 20px;
      display: none;
    }
    .completion-banner.show { display: block; }
    .completion-banner h3 {
      font-family: 'Noto Serif KR', serif;
      font-size: 18px;
      color: var(--soft-lavender);
      margin-bottom: 6px;
    }
    .completion-banner p { font-size: 13px; color: var(--text3); }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    /* Responsive */
    @media (min-width: 480px) {
      #app { max-width: 480px; margin: 0 auto; }
    }
  </style>
</head>
<body>
  <div id="authBar" style="display:flex;gap:8px;align-items:center;padding:12px 16px;">
  <button id="loginBtn">Googleë¡œ ë¡œê·¸ì¸</button>
  <button id="logoutBtn" style="display:none;">ë¡œê·¸ì•„ì›ƒ</button>
  <span id="userLabel" style="opacity:.9;"></span>
</div>
<div class="stars"></div>
<div id="app">
  <div class="header">
    <div class="logo">ë¯¸ë˜ì €ë„ âœ¦</div>
    <div class="logo-sub">AIëŠ” ë„êµ¬ë‹¤. ë‚˜ëŠ” ë°©í–¥ì´ë‹¤.</div>
    <div class="streak-badge">
      <span>ğŸ”¥</span>
      <span id="streak-text">0ì¼ ì—°ì† ì‘ì„± ì¤‘</span>
    </div>
  </div>

  <!-- TODAY PAGE -->
  <div id="page-today" class="page active">
    <div class="date-label" id="today-date"></div>
    <div class="greeting" id="greeting">ì˜¤ëŠ˜ë„ ë‚˜ë¥¼ í–¥í•œ ì—¬ì •ì„ ì‹œì‘í•´ìš”</div>
    <div class="greeting-sub">6ê°€ì§€ ì§ˆë¬¸ì— ë‹µí•˜ë©° 9ë²ˆì§¸ ì§€ëŠ¥ì„ í›ˆë ¨í•˜ì„¸ìš”</div>

    <div class="progress-bar">
      <div class="progress-fill" id="progress-fill" style="width:0%"></div>
    </div>

    <div class="completion-banner" id="completion-banner">
      <h3>âœ¦ ì˜¤ëŠ˜ì˜ ì €ë„ ì™„ì„±!</h3>
      <p>ë§¤ì¼ ìŒ“ì´ëŠ” ê¸°ë¡ì´ ë‚˜ë§Œì˜ ì„±ì¥ ì§€ë„ê°€ ë©ë‹ˆë‹¤</p>
    </div>

    <div id="questions-container"></div>
    <button class="save-btn" onclick="saveToday()">ì˜¤ëŠ˜ì˜ ì €ë„ ì €ì¥í•˜ê¸°</button>
  </div>

  <!-- INSIGHT PAGE -->
  <div id="page-insight" class="page">
    <br>
    <div class="section-title">ğŸ“Š ë‚˜ì˜ ì„±ì¥ ì§€ë„</div>

    <div class="stats-row">
      <div class="stat-card">
        <div class="stat-num" id="total-days">0</div>
        <div class="stat-label">ì´ ì‘ì„±ì¼</div>
      </div>
      <div class="stat-card">
        <div class="stat-num" id="streak-num">0</div>
        <div class="stat-label">ì—°ì† ì‘ì„±</div>
      </div>
    </div>

    <div class="insight-card">
      <h3>ğŸ¤– 9ë²ˆì§¸ ì§€ëŠ¥ ì§€ìˆ˜</h3>
      <div class="gauge-wrap">
        <div class="gauge-num" id="ninth-score">--</div>
        <div class="gauge-label">ë©”íƒ€ì¸ì§€ Â· ì„œë²ˆíŠ¸ ë¦¬ë”ì‹­</div>
        <div class="gauge-bar"><div class="gauge-fill" id="ninth-bar" style="width:0%"></div></div>
        <div style="font-size:12px;color:var(--text3);" id="ninth-msg">ì €ë„ì„ ìŒ“ì„ìˆ˜ë¡ ì§€ìˆ˜ê°€ ì¸¡ì •ë©ë‹ˆë‹¤</div>
      </div>
    </div>

    <div class="insight-card">
      <h3>ğŸ“… ì´ë²ˆ ë‹¬ ê°ì • ë‹¬ë ¥</h3>
      <div class="cal-grid" id="cal-grid"></div>
    </div>

    <div class="insight-card">
      <h3>ğŸ”‘ ë‚˜ì˜ í•µì‹¬ í‚¤ì›Œë“œ</h3>
      <div id="keywords" style="display:flex;flex-wrap:wrap;gap:8px;min-height:40px;">
        <span style="color:var(--text3);font-size:13px;">ì €ë„ì„ ì‘ì„±í•˜ë©´ í‚¤ì›Œë“œê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤</span>
      </div>
    </div>
  </div>

  <!-- HISTORY PAGE -->
  <div id="page-history" class="page">
    <br>
    <div class="section-title">ğŸ“– ì§€ë‚œ ê¸°ë¡</div>
    <div id="history-list">
      <div style="text-align:center;color:var(--text3);padding:40px 0;font-size:14px;">
        ì•„ì§ ì €ì¥ëœ ê¸°ë¡ì´ ì—†ì–´ìš”<br>
        <span style="font-size:12px;margin-top:8px;display:block">ì˜¤ëŠ˜ì˜ ì €ë„ì„ ì‘ì„±í•´ë³´ì„¸ìš”!</span>
      </div>
    </div>
  </div>

  <!-- AI PAGE -->
  <div id="page-ai" class="page">
    <br>
    <div class="section-title">ğŸ¤– AI ë™ë°˜ì ìƒë‹´</div>
    <div class="ai-chat" id="ai-chat">
      <div class="ai-msg-label">
        <span style="width:20px;height:20px;background:linear-gradient(135deg,var(--purple),var(--indigo));border-radius:50%;display:inline-block"></span>
        ë¯¸ë˜ì €ë„ AI
      </div>
      <div class="ai-msg" id="ai-welcome">
        ì•ˆë…•í•˜ì„¸ìš” ğŸ˜Š ì €ëŠ” ë‹¹ì‹ ì˜ ì €ë„ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ëŒ€í™”í•˜ëŠ” AI ë™ë°˜ìì˜ˆìš”.<br><br>
        ì¼ë°˜ AIëŠ” ì§€ê¸ˆ ë§í•œ ê²ƒë§Œ ì•Œì§€ë§Œ, ì €ëŠ” <strong>ë‹¹ì‹ ì˜ ëˆ„ì  ê¸°ë¡</strong>ì„ ë°”íƒ•ìœ¼ë¡œ ë” ê¹Šì€ ëŒ€í™”ë¥¼ ë‚˜ëˆŒ ìˆ˜ ìˆì–´ìš”.<br><br>
        ì˜¤ëŠ˜ ì–´ë–¤ ê²ƒì´ ë§ˆìŒì— ê±¸ë¦¬ë‚˜ìš”?
      </div>
      <div id="ai-messages"></div>
    </div>
    <div class="ai-input-row">
      <input class="ai-input" id="ai-input" placeholder="AI ë™ë°˜ìì—ê²Œ ë§í•´ë³´ì„¸ìš”..." onkeydown="if(event.key==='Enter')sendAI()" />
      <button class="ai-send" onclick="sendAI()">â†‘</button>
    </div>
    <div style="font-size:11px;color:var(--text3);text-align:center;margin-top:10px">
      ì €ë„ì„ ë§ì´ ìŒ“ì„ìˆ˜ë¡ ë” ê¹Šì€ ëŒ€í™”ê°€ ê°€ëŠ¥í•´ìš”
    </div>
  </div>
</div>

<!-- Bottom Nav -->
<nav class="nav">
  <button class="nav-btn active" onclick="showPage('today',this)">
    <svg fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
    ì˜¤ëŠ˜
  </button>
  <button class="nav-btn" onclick="showPage('insight',this)">
    <svg fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>
    ì¸ì‚¬ì´íŠ¸
  </button>
  <button class="nav-btn" onclick="showPage('history',this)">
    <svg fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>
    ê¸°ë¡
  </button>
  <button class="nav-btn" onclick="showPage('ai',this)">
    <svg fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 8v4M12 16h.01"/></svg>
    AIìƒë‹´
  </button>
</nav>

<div class="toast" id="toast"></div>

<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
<script>
  const firebaseConfig = {
  apiKey: "...",
  authDomain: "...",
  projectId: "...",
};

if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();

window.addEventListener("DOMContentLoaded", () => {
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const userLabel = document.getElementById("userLabel");

  loginBtn.addEventListener("click", async () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    await auth.signInWithPopup(provider);
  });

  logoutBtn.addEventListener("click", async () => {
    await auth.signOut();
  });

  auth.onAuthStateChanged((user) => {
    if (user) {
      loginBtn.style.display = "none";
      logoutBtn.style.display = "inline-block";
      userLabel.textContent = `${user.displayName || "User"} (${user.email || ""})`;
    } else {
      loginBtn.style.display = "inline-block";
      logoutBtn.style.display = "none";
      userLabel.textContent = "";
    }
  });
});
  const firebaseConfig = {
  apiKey: "...",
  authDomain: "...",
  projectId: "...",
};

if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();

const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const userLabel = document.getElementById("userLabel");

loginBtn.addEventListener("click", async () => {
  const provider = new firebase.auth.GoogleAuthProvider();
  await auth.signInWithPopup(provider);
});

logoutBtn.addEventListener("click", async () => {
  await auth.signOut();
});

auth.onAuthStateChanged((user) => {
  if (user) {
    loginBtn.style.display = "none";
    logoutBtn.style.display = "inline-block";
    userLabel.textContent = `${user.displayName || "User"} (${user.email || ""})`;
  } else {
    loginBtn.style.display = "inline-block";
    logoutBtn.style.display = "none";
    userLabel.textContent = "";
  }
});
const QUESTIONS = [
  { emoji:'ğŸŒ¸', cat:'ê°ì‚¬', text:'ì˜¤ëŠ˜ ê°ì‚¬í•œ ê²ƒ 3ê°€ì§€ë¥¼ ì ì–´ë³´ì„¸ìš”.', placeholder:'ì˜¤ëŠ˜ ê³ ë§ˆì› ë˜ ê²ƒë“¤ì„ ë– ì˜¬ë ¤ë³´ì„¸ìš”...' },
  { emoji:'ğŸ§­', cat:'ì¡´ì¬ì´ìœ ', text:'ë‚˜ëŠ” ì™œ ì‚´ê³  ìˆë‚˜ìš”? ì™œ ì§€ê¸ˆ ì´ ì¼ì„ í•˜ê³  ìˆë‚˜ìš”?', placeholder:'ë‚˜ë¥¼ ì›€ì§ì´ëŠ” í˜ì€ ë¬´ì—‡ì¸ì§€ ì†”ì§í•˜ê²Œ ì ì–´ë³´ì„¸ìš”...' },
  { emoji:'âš¡', cat:'ëª°ì…', text:'ì˜¤ëŠ˜ ì‹œê°„ ê°€ëŠ” ì¤„ ëª¨ë¥´ê³  ë¹ ì ¸ë“  ê²ƒì´ ìˆì—ˆë‚˜ìš”?', placeholder:'ì‹œê°„ì´ ë©ˆì¶˜ ê²ƒì²˜ëŸ¼ ëŠê»´ì§„ ìˆœê°„ì´ ìˆì—ˆë‚˜ìš”...' },
  { emoji:'ğŸ’ª', cat:'ë¦¬ë”ì‹­', text:'ì˜¤ëŠ˜ ë‚´ê°€ ì‹¤ì²œí•œ ë¦¬ë”ì‹­ì´ ìˆì—ˆë‚˜ìš”?', placeholder:'ëˆ„êµ°ê°€ë¥¼ ìœ„í•´ í•œ ì¼, ì„¬ê¹€ì˜ ìˆœê°„ì„ ì ì–´ë³´ì„¸ìš”...' },
  { emoji:'ğŸŒŸ', cat:'ì˜í–¥ë ¥', text:'ì˜¤ëŠ˜ ì„ í•œ ì˜í–¥ë ¥ì„ ë¼ì¹œ ì‚¬ëŒì´ ìˆë‹¤ë©´ ëˆ„êµ¬ì¸ê°€ìš”?', placeholder:'ì˜¤ëŠ˜ ë³¸ë°›ê³  ì‹¶ì—ˆë˜ ì‚¬ëŒì´ë‚˜ ìˆœê°„ì„ ì ì–´ë³´ì„¸ìš”...' },
  { emoji:'ğŸ”¥', cat:'ê°ì •', text:'ì˜¤ëŠ˜ ê°€ì¥ í™”ê°€ ë‚¬ë˜ ìˆœê°„ì„ ì ì–´ë³´ì„¸ìš”.', placeholder:'ì†”ì§í•œ ê°ì •ì´ ê°€ì¥ ê¹Šì€ ìê¸°ì´í•´ì˜ ì‹œì‘ì…ë‹ˆë‹¤...' },
];

let todayAnswers = {};
let mediaRecorder = null;
let currentRecordingIdx = null;

// Storage helpers
function load(key) { try { return JSON.parse(localStorage.getItem(key)); } catch { return null; } }
function save(key, val) { localStorage.setItem(key, JSON.stringify(val)); }

function getTodayKey() {
  const d = new Date();
  return `journal_${d.getFullYear()}_${d.getMonth()+1}_${d.getDate()}`;
}

function getAllJournals() {
  const all = [];
  for (let i = 0; i < localStorage.length; i++) {
    const k = localStorage.key(i);
    if (k && k.startsWith('journal_')) {
      const v = load(k);
      if (v) all.push({ key: k, ...v });
    }
  }
  return all.sort((a,b) => b.key.localeCompare(a.key));
}

// Init
function init() {
  setDate();
  buildQuestions();
  loadTodayData();
  updateProgress();
  updateStreak();
}

function setDate() {
  const d = new Date();
  const days = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
  document.getElementById('today-date').textContent =
    `${d.getFullYear()}ë…„ ${d.getMonth()+1}ì›” ${d.getDate()}ì¼ ${days[d.getDay()]}ìš”ì¼`;
}

function buildQuestions() {
  const c = document.getElementById('questions-container');
  c.innerHTML = '';
  QUESTIONS.forEach((q, i) => {
    const div = document.createElement('div');
    div.className = 'question-card';
    div.id = `qcard-${i}`;
    div.innerHTML = `
      <div class="q-header">
        <span class="q-emoji">${q.emoji}</span>
        <div class="q-meta">
          <div class="q-category">${q.cat}</div>
          <div class="q-text">${q.text}</div>
        </div>
        <div class="q-check" id="check-${i}">
          <svg fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M20 6L9 17l-5-5"/></svg>
        </div>
      </div>
      <textarea id="ans-${i}" placeholder="${q.placeholder}" rows="3"
        oninput="onAnswer(${i})"></textarea>
      <button class="mic-btn" id="mic-${i}" onclick="toggleRecord(${i})">
        ğŸ™ ìŒì„±ìœ¼ë¡œ ë‹µí•˜ê¸°
      </button>
    `;
    c.appendChild(div);
  });
}

function loadTodayData() {
  const data = load(getTodayKey());
  if (data && data.answers) {
    todayAnswers = data.answers;
    QUESTIONS.forEach((_, i) => {
      const ta = document.getElementById(`ans-${i}`);
      if (ta && todayAnswers[i]) {
        ta.value = todayAnswers[i];
        markAnswered(i);
      }
    });
  }
}

function onAnswer(i) {
  const val = document.getElementById(`ans-${i}`).value.trim();
  if (val) {
    todayAnswers[i] = val;
    markAnswered(i);
  } else {
    delete todayAnswers[i];
    document.getElementById(`check-${i}`).classList.remove('visible');
    document.getElementById(`qcard-${i}`).classList.remove('answered');
  }
  updateProgress();
}

function markAnswered(i) {
  document.getElementById(`check-${i}`).classList.add('visible');
  document.getElementById(`qcard-${i}`).classList.add('answered');
}

function updateProgress() {
  const count = Object.keys(todayAnswers).length;
  const pct = (count / QUESTIONS.length) * 100;
  document.getElementById('progress-fill').style.width = pct + '%';
  if (count === QUESTIONS.length) {
    document.getElementById('completion-banner').classList.add('show');
  }
}

function saveToday() {
  const count = Object.keys(todayAnswers).length;
  if (count === 0) { showToast('ìµœì†Œ 1ê°œ ì´ìƒ ë‹µë³€ì„ ì‘ì„±í•´ì£¼ì„¸ìš”'); return; }
  save(getTodayKey(), { answers: todayAnswers, date: new Date().toISOString(), count });
  updateStreak();
  showToast(`âœ¦ ${count}ê°œ ë‹µë³€ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤`);
}

function updateStreak() {
  const journals = getAllJournals();
  let streak = 0;
  const today = new Date();
  for (let i = 0; i < 365; i++) {
    const d = new Date(today);
    d.setDate(d.getDate() - i);
    const key = `journal_${d.getFullYear()}_${d.getMonth()+1}_${d.getDate()}`;
    if (load(key)) streak++;
    else if (i > 0) break;
  }
  document.getElementById('streak-text').textContent = `${streak}ì¼ ì—°ì† ì‘ì„± ì¤‘`;
  document.getElementById('streak-num').textContent = streak;
  document.getElementById('total-days').textContent = journals.length;
  updateNinthScore(journals.length, streak);
  buildCalendar();
  buildHistory();
  buildKeywords();
}

function updateNinthScore(total, streak) {
  if (total === 0) return;
  const score = Math.min(99, Math.round(20 + (total * 2) + (streak * 3)));
  document.getElementById('ninth-score').textContent = score;
  document.getElementById('ninth-bar').style.width = score + '%';
  const msgs = ['ì‹œì‘ì´ ë°˜ì´ì—ìš”! ê³„ì† ê¸°ë¡í•´ë³´ì„¸ìš”', 'ê¾¸ì¤€íˆ í›ˆë ¨ ì¤‘ì´ì—ìš”', 'ì„±ì¥ì´ ëŠê»´ì§‘ë‹ˆë‹¤!', 'ë‹¹ì‹ ì€ ë¶„ëª…íˆ ì•ìœ¼ë¡œ ë‚˜ì•„ê°€ê³  ìˆì–´ìš”'];
  document.getElementById('ninth-msg').textContent = score < 40 ? msgs[0] : score < 60 ? msgs[1] : score < 80 ? msgs[2] : msgs[3];
}

function buildCalendar() {
  const grid = document.getElementById('cal-grid');
  const today = new Date();
  const year = today.getFullYear();
  const month = today.getMonth();
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month+1, 0).getDate();
  grid.innerHTML = '';
  ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '].forEach(d => {
    const el = document.createElement('div');
    el.className = 'cal-day';
    el.style.fontWeight = '600';
    el.style.color = 'var(--text3)';
    el.textContent = d;
    grid.appendChild(el);
  });
  for (let i = 0; i < firstDay; i++) {
    grid.appendChild(document.createElement('div'));
  }
  for (let d = 1; d <= daysInMonth; d++) {
    const key = `journal_${year}_${month+1}_${d}`;
    const hasEntry = !!load(key);
    const isToday = d === today.getDate();
    const el = document.createElement('div');
    el.className = 'cal-day' + (hasEntry ? ' has-entry' : '') + (isToday ? ' today' : '');
    el.textContent = hasEntry ? 'âœ¦' : d;
    if (!hasEntry) el.style.color = isToday ? 'var(--lavender)' : 'var(--text3)';
    grid.appendChild(el);
  }
}

function buildHistory() {
  const journals = getAllJournals();
  const el = document.getElementById('history-list');
  if (journals.length === 0) {
    el.innerHTML = '<div style="text-align:center;color:var(--text3);padding:40px 0;font-size:14px;">ì•„ì§ ì €ì¥ëœ ê¸°ë¡ì´ ì—†ì–´ìš”<br><span style="font-size:12px;margin-top:8px;display:block">ì˜¤ëŠ˜ì˜ ì €ë„ì„ ì‘ì„±í•´ë³´ì„¸ìš”!</span></div>';
    return;
  }
  el.innerHTML = journals.map(j => {
    const parts = j.key.split('_');
    const dateStr = `${parts[1]}ë…„ ${parts[2]}ì›” ${parts[3]}ì¼`;
    const answers = j.answers || {};
    const firstQ = Object.keys(answers)[0];
    const preview = firstQ !== undefined ? answers[firstQ] : '';
    const q = QUESTIONS[firstQ] || {};
    return `<div class="history-item">
      <div class="history-date">ğŸ“… ${dateStr} Â· ${j.count || Object.keys(answers).length}ê°œ ë‹µë³€</div>
      ${firstQ !== undefined ? `<div class="history-q">${q.emoji||''} ${q.cat||''}</div><div class="history-a history-preview">${preview}</div>` : ''}
    </div>`;
  }).join('');
}

function buildKeywords() {
  const journals = getAllJournals();
  if (journals.length === 0) return;
  const wordCount = {};
  const stopwords = new Set(['ë‚˜ëŠ”','ì˜¤ëŠ˜','ìˆì—ˆ','ìˆì—ˆë‚˜ìš”','ê²ƒì´','ê°™ì€','ê·¸ë¦¬ê³ ','í•˜ì§€ë§Œ','ê·¸ë˜ì„œ','ë•Œë¬¸ì—','ì •ë§','ë„ˆë¬´','ë§ì´','ì¡°ê¸ˆ','ì•„ì£¼','ìˆ˜','ê²ƒ','ë“±','ë“¤','ì´','ê°€','ì„','ë¥¼','ì—','ì˜','ì™€','ê³¼','ë„','ì€','ëŠ”','ì—ì„œ','ìœ¼ë¡œ','ë¡œ','ì—ê²Œ','ê»˜ì„œ','ì´ë‚˜','ì´ë“ ','ë“ ','ë¼ë„','ë¼ì„œ','ë¼ê³ ','ë”','ì•Š','ì—†','ìˆ','í–ˆ','í•œ','í•˜ëŠ”','í• ','í•´ì„œ','ë˜ì–´','ë˜ì—ˆ','ìœ„í•´','ëŒ€í•œ','ë¼ëŠ”','ì´ë¼ê³ ','ì—ëŠ”','ë§Œ','ë¶€í„°','ê¹Œì§€','ì²˜ëŸ¼','ë³´ë‹¤']);
  journals.forEach(j => {
    Object.values(j.answers || {}).forEach(text => {
      text.split(/[\s,.!?]+/).forEach(w => {
        const clean = w.replace(/[^\wê°€-í£]/g,'');
        if (clean.length >= 2 && !stopwords.has(clean)) {
          wordCount[clean] = (wordCount[clean]||0)+1;
        }
      });
    });
  });
  const sorted = Object.entries(wordCount).sort((a,b)=>b[1]-a[1]).slice(0,15);
  const kwEl = document.getElementById('keywords');
  if (sorted.length === 0) return;
  const maxCount = sorted[0][1];
  kwEl.innerHTML = sorted.map(([w,c]) => {
    const size = 11 + Math.round((c/maxCount)*8);
    const op = 0.5 + (c/maxCount)*0.5;
    return `<span style="font-size:${size}px;color:var(--lavender);opacity:${op};background:rgba(124,58,237,0.15);padding:4px 10px;border-radius:20px;border:1px solid var(--border)">${w}</span>`;
  }).join('');
}

// Voice recording
async function toggleRecord(i) {
  const btn = document.getElementById(`mic-${i}`);
  if (mediaRecorder && mediaRecorder.state === 'recording') {
    mediaRecorder.stop();
    btn.classList.remove('recording');
    btn.textContent = 'ğŸ™ ìŒì„±ìœ¼ë¡œ ë‹µí•˜ê¸°';
    return;
  }
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const chunks = [];
    mediaRecorder = new MediaRecorder(stream);
    currentRecordingIdx = i;
    btn.classList.add('recording');
    btn.textContent = 'â¹ ë…¹ìŒ ì¤‘... (í´ë¦­í•˜ì—¬ ì™„ë£Œ)';
    mediaRecorder.ondataavailable = e => chunks.push(e.data);
    mediaRecorder.onstop = () => {
      stream.getTracks().forEach(t => t.stop());
      const blob = new Blob(chunks, { type: 'audio/webm' });
      transcribeAudio(blob, i);
    };
    mediaRecorder.start();
  } catch {
    showToast('ë§ˆì´í¬ ì ‘ê·¼ ê¶Œí•œì´ í•„ìš”í•´ìš”');
  }
}

function transcribeAudio(blob, i) {
  if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
    showToast('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•Šì•„ìš”');
    return;
  }
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  const sr = new SR();
  sr.lang = 'ko-KR';
  sr.interimResults = false;
  sr.onresult = e => {
    const text = e.results[0][0].transcript;
    const ta = document.getElementById(`ans-${i}`);
    ta.value = (ta.value ? ta.value + ' ' : '') + text;
    onAnswer(i);
  };
  sr.onerror = () => showToast('ìŒì„± ì¸ì‹ì— ì‹¤íŒ¨í–ˆì–´ìš”. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
  sr.start();
}

// AI Chat
const aiResponses = [
  'ì €ë„ì„ ê¾¸ì¤€íˆ ì‘ì„±í•˜ë©´ì„œ ë‹¹ì‹  ì•ˆì— ì–´ë–¤ ë³€í™”ê°€ ëŠê»´ì§€ë‚˜ìš”? ì‘ì€ ë³€í™”ë„ ì†Œì¤‘í•´ìš”.',
  'ì˜¤ëŠ˜ ì‘ì„±í•œ ê°ì‚¬ í•­ëª©ì„ ë³´ë©´, ë‹¹ì‹ ì´ ì†Œì¤‘íˆ ì—¬ê¸°ëŠ” ê²ƒë“¤ì´ ë³´ì—¬ìš”. ê·¸ê²ƒë“¤ì´ ë‹¹ì‹ ì˜ ê°€ì¹˜ê´€ì´ì—ìš”.',
  'ëª°ì…í–ˆë˜ ìˆœê°„ì„ ê¸°ì–µí•´ë³´ì„¸ìš”. ê·¸ ì•ˆì— ë‹¹ì‹ ì˜ ê°•ì ì´ ìˆ¨ì–´ ìˆì–´ìš”.',
  'ë¦¬ë”ì‹­ì€ ê±°ì°½í•œ ê²ƒì´ ì•„ë‹ˆì—ìš”. ì˜¤ëŠ˜ ëˆ„êµ°ê°€ë¥¼ ìœ„í•´ í•œ ì‘ì€ í–‰ë™ë„ ì„œë²ˆíŠ¸ ë¦¬ë”ì‹­ì´ì—ìš”.',
  'ê°ì •ì„ ì†”ì§í•˜ê²Œ ê¸°ë¡í•˜ëŠ” ê²ƒ ìì²´ê°€ 9ë²ˆì§¸ ì§€ëŠ¥ì„ í›ˆë ¨í•˜ëŠ” ê±°ì˜ˆìš”. ì˜ í•˜ê³  ìˆì–´ìš”.',
  'ë‹¹ì‹ ì˜ ê¸°ë¡ì´ ìŒ“ì¼ìˆ˜ë¡, ì €ëŠ” ë” ê¹Šì´ ë‹¹ì‹ ì„ ì´í•´í•  ìˆ˜ ìˆê²Œ ë¼ìš”. ê³„ì†í•´ì£¼ì„¸ìš”.',
  'ê³¼ê±°ì˜ ê¸°ë¡ì„ ëŒì•„ë³´ë©´ ë¶„ëª…íˆ ì„±ì¥í•œ ìì‹ ì„ ë°œê²¬í•  ìˆ˜ ìˆì„ ê±°ì˜ˆìš”.',
];
let aiIdx = 0;

function sendAI() {
  const input = document.getElementById('ai-input');
  const msg = input.value.trim();
  if (!msg) return;
  const chat = document.getElementById('ai-messages');
  const userEl = document.createElement('div');
  userEl.style.cssText = 'text-align:right;margin-bottom:10px';
  userEl.innerHTML = `<span style="background:linear-gradient(135deg,var(--purple),var(--indigo));color:white;padding:10px 14px;border-radius:12px 12px 4px 12px;font-size:14px;display:inline-block;max-width:80%;text-align:left">${msg}</span>`;
  chat.appendChild(userEl);
  input.value = '';
  setTimeout(() => {
    const journals = getAllJournals();
    let response = aiResponses[aiIdx % aiResponses.length];
    aiIdx++;
    if (journals.length === 0) response = 'ì•„ì§ ì €ë„ì´ ì—†ë„¤ìš”. ì˜¤ëŠ˜ íƒ­ì—ì„œ ì²« ë²ˆì§¸ ê¸°ë¡ì„ ë‚¨ê²¨ë³´ì„¸ìš”! ê¸°ë¡ì´ ìŒ“ì¼ìˆ˜ë¡ ë” ê¹Šì€ ëŒ€í™”ë¥¼ ë‚˜ëˆŒ ìˆ˜ ìˆì–´ìš”.';
    const aiEl = document.createElement('div');
    aiEl.innerHTML = `<div class="ai-msg-label"><span style="width:20px;height:20px;background:linear-gradient(135deg,var(--purple),var(--indigo));border-radius:50%;display:inline-block"></span>ë¯¸ë˜ì €ë„ AI</div><div class="ai-msg">${response}</div>`;
    chat.appendChild(aiEl);
    chat.scrollTop = chat.scrollHeight;
  }, 800);
}

// Navigation
function showPage(name, btn) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  btn.classList.add('active');
  if (name === 'insight') { buildCalendar(); buildHistory(); buildKeywords(); updateStreak(); }
  if (name === 'history') buildHistory();
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

init();
</script>
</body>
</html>
