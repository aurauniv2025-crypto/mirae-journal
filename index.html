<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ë¯¸ë˜ì €ë„ â€” AIê°€ ëŒ€ì²´í•  ìˆ˜ ì—†ëŠ” ëŠ¥ë ¥ì„ ë§¤ì¼ í›ˆë ¨í•˜ëŠ” í”Œë«í¼</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@300;400;600;700&family=Noto+Sans+KR:wght@300;400;500;600&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --purple: #7C3AED;
      --indigo: #4F46E5;
      --lavender: #A78BFA;
      --soft-lavender: #C4B5FD;
      --bg: #0F0B1E;
      --bg2: #1A1332;
      --bg3: #231A45;
      --card: #1E1540;
      --card2: #2A1D58;
      --border: rgba(167,139,250,0.18);
      --text: #F3F0FF;
      --text2: #C4B5FD;
      --text3: #9C85D4;
      --success: #34D399;
    }

    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    .stars {
      position: fixed; inset: 0; z-index: 0; pointer-events: none;
      background: radial-gradient(ellipse at 20% 50%, rgba(79,70,229,0.08) 0%, transparent 60%),
                  radial-gradient(ellipse at 80% 20%, rgba(124,58,237,0.06) 0%, transparent 60%);
    }
    .stars::before {
      content: '';
      position: absolute; inset: 0;
      background-image:
        radial-gradient(1px 1px at 10% 15%, rgba(255,255,255,0.6) 0%, transparent 100%),
        radial-gradient(1px 1px at 25% 40%, rgba(255,255,255,0.4) 0%, transparent 100%),
        radial-gradient(1px 1px at 50% 10%, rgba(255,255,255,0.5) 0%, transparent 100%),
        radial-gradient(1px 1px at 70% 60%, rgba(255,255,255,0.3) 0%, transparent 100%),
        radial-gradient(1px 1px at 85% 25%, rgba(255,255,255,0.6) 0%, transparent 100%),
        radial-gradient(1px 1px at 40% 75%, rgba(255,255,255,0.4) 0%, transparent 100%),
        radial-gradient(1px 1px at 90% 80%, rgba(255,255,255,0.5) 0%, transparent 100%),
        radial-gradient(1px 1px at 15% 85%, rgba(255,255,255,0.3) 0%, transparent 100%),
        radial-gradient(1px 1px at 60% 45%, rgba(200,180,255,0.5) 0%, transparent 100%),
        radial-gradient(1px 1px at 35% 25%, rgba(200,180,255,0.4) 0%, transparent 100%);
    }

    #app { position: relative; z-index: 1; min-height: 100vh; padding-bottom: 80px; }

    .header { text-align: center; padding: 40px 20px 24px; }
    .logo {
      font-family: 'Noto Serif KR', serif;
      font-size: 28px; font-weight: 700;
      background: linear-gradient(135deg, var(--soft-lavender), var(--lavender), var(--purple));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
      letter-spacing: -0.5px;
    }
    .logo-sub { font-size: 12px; color: var(--text3); margin-top: 4px; letter-spacing: 0.5px; }
    .streak-badge {
      display: inline-flex; align-items: center; gap: 6px;
      background: rgba(124,58,237,0.2); border: 1px solid var(--border);
      border-radius: 20px; padding: 6px 14px; font-size: 13px; color: var(--lavender); margin-top: 12px;
    }

    .nav {
      display: flex; background: var(--card); border-top: 1px solid var(--border);
      position: fixed; bottom: 0; left: 0; right: 0; z-index: 100;
    }
    .nav-btn {
      flex: 1; display: flex; flex-direction: column; align-items: center; gap: 3px;
      padding: 10px 4px; background: none; border: none; color: var(--text3);
      font-size: 10px; font-family: 'Noto Sans KR', sans-serif; cursor: pointer; transition: color 0.2s;
    }
    .nav-btn.active { color: var(--lavender); }
    .nav-btn svg { width: 22px; height: 22px; }

    .page { display: none; padding: 0 16px; }
    .page.active { display: block; }

    .date-label { text-align: center; color: var(--text3); font-size: 13px; margin-bottom: 20px; }
    .greeting { font-family: 'Noto Serif KR', serif; font-size: 20px; font-weight: 600; text-align: center; color: var(--text); margin-bottom: 6px; }
    .greeting-sub { font-size: 13px; color: var(--text3); text-align: center; margin-bottom: 28px; }

    .question-card {
      background: var(--card); border: 1px solid var(--border);
      border-radius: 16px; padding: 20px; margin-bottom: 16px; transition: border-color 0.2s;
    }
    .question-card.answered { border-color: rgba(167,139,250,0.4); }
    .q-header { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
    .q-emoji { font-size: 22px; }
    .q-meta { flex: 1; }
    .q-category { font-size: 11px; color: var(--text3); margin-bottom: 2px; }
    .q-text { font-family: 'Noto Serif KR', serif; font-size: 15px; color: var(--text); line-height: 1.6; }
    .q-check {
      width: 22px; height: 22px; border-radius: 50%;
      background: rgba(52,211,153,0.15); border: 1px solid var(--success);
      display: flex; align-items: center; justify-content: center;
      opacity: 0; transition: opacity 0.3s; flex-shrink: 0;
    }
    .q-check.visible { opacity: 1; }
    .q-check svg { width: 13px; height: 13px; color: var(--success); }

    textarea {
      width: 100%; background: var(--bg3); border: 1px solid var(--border);
      border-radius: 10px; color: var(--text); font-family: 'Noto Sans KR', sans-serif;
      font-size: 14px; line-height: 1.7; padding: 12px; resize: none;
      min-height: 90px; outline: none; transition: border-color 0.2s;
    }
    textarea:focus { border-color: var(--lavender); }
    textarea::placeholder { color: var(--text3); }

    .mic-btn {
      display: flex; align-items: center; gap: 6px; background: none;
      border: 1px solid var(--border); border-radius: 8px; color: var(--text3);
      font-size: 12px; font-family: 'Noto Sans KR', sans-serif;
      padding: 6px 12px; margin-top: 8px; cursor: pointer; transition: all 0.2s;
    }
    .mic-btn:hover { color: var(--lavender); border-color: var(--lavender); }
    .mic-btn.recording { color: #F87171; border-color: #F87171; animation: pulse 1s infinite; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }

    .save-btn {
      width: 100%; background: linear-gradient(135deg, var(--purple), var(--indigo));
      border: none; border-radius: 14px; color: white; font-family: 'Noto Sans KR', sans-serif;
      font-size: 16px; font-weight: 600; padding: 16px; margin-top: 8px;
      cursor: pointer; transition: opacity 0.2s, transform 0.1s;
    }
    .save-btn:hover { opacity: 0.9; }
    .save-btn:active { transform: scale(0.98); }

    .progress-bar { background: var(--bg3); border-radius: 4px; height: 4px; margin: 0 0 24px; overflow: hidden; }
    .progress-fill { height: 100%; border-radius: 4px; background: linear-gradient(90deg, var(--purple), var(--lavender)); transition: width 0.4s ease; }

    .section-title { font-family: 'Noto Serif KR', serif; font-size: 18px; font-weight: 600; color: var(--text); margin-bottom: 16px; }

    .insight-card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 20px; margin-bottom: 16px; }
    .insight-card h3 { font-size: 14px; color: var(--text2); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    .insight-story { font-size: 14px; color: var(--text); line-height: 1.9; }
    .insight-story strong { color: var(--soft-lavender); }

    .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
    .cal-day { aspect-ratio: 1; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 10px; color: var(--text3); }
    .cal-day.has-entry { background: linear-gradient(135deg, var(--purple), var(--indigo)); color: white; font-size: 14px; }
    .cal-day.today { border: 1px solid var(--lavender); }

    .stats-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
    .stat-card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 16px; text-align: center; }
    .stat-num {
      font-family: 'Noto Serif KR', serif; font-size: 32px; font-weight: 700;
      background: linear-gradient(135deg, var(--soft-lavender), var(--lavender));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
    }
    .stat-label { font-size: 12px; color: var(--text3); margin-top: 4px; }

    .history-item { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 16px; margin-bottom: 12px; }
    .history-date { font-size: 12px; color: var(--text3); margin-bottom: 10px; }
    .history-q { font-size: 12px; color: var(--lavender); margin-bottom: 4px; }
    .history-a { font-size: 14px; color: var(--text); line-height: 1.6; }
    .history-preview { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

    .ai-chat { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 20px; margin-bottom: 16px; min-height: 200px; }
    .ai-msg { background: var(--bg3); border-radius: 12px 12px 12px 4px; padding: 14px; font-size: 14px; line-height: 1.7; color: var(--text2); margin-bottom: 12px; }
    .ai-msg-label { font-size: 11px; color: var(--text3); margin-bottom: 6px; display: flex; align-items: center; gap: 6px; }
    .user-msg { background: rgba(124,58,237,0.2); border-radius: 12px 12px 4px 12px; padding: 14px; font-size: 14px; line-height: 1.7; color: var(--text); margin-bottom: 12px; text-align: right; }
    .ai-input-row { display: flex; gap: 8px; margin-top: 12px; }
    .ai-input { flex: 1; background: var(--bg3); border: 1px solid var(--border); border-radius: 10px; color: var(--text); font-family: 'Noto Sans KR', sans-serif; font-size: 14px; padding: 10px 14px; outline: none; }
    .ai-input:focus { border-color: var(--lavender); }
    .ai-send { background: linear-gradient(135deg, var(--purple), var(--indigo)); border: none; border-radius: 10px; color: white; font-size: 18px; width: 44px; cursor: pointer; }

    .toast {
      position: fixed; bottom: 90px; left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: var(--card2); border: 1px solid var(--lavender);
      border-radius: 12px; padding: 12px 20px; font-size: 14px; color: var(--lavender);
      opacity: 0; transition: all 0.3s; z-index: 200; white-space: nowrap;
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

    .completion-banner {
      background: linear-gradient(135deg, rgba(124,58,237,0.3), rgba(79,70,229,0.3));
      border: 1px solid var(--lavender); border-radius: 16px; padding: 20px;
      text-align: center; margin-bottom: 20px; display: none;
    }
    .completion-banner.show { display: block; }
    .completion-banner h3 { font-family: 'Noto Serif KR', serif; font-size: 18px; color: var(--soft-lavender); margin-bottom: 6px; }
    .completion-banner p { font-size: 13px; color: var(--text3); }

    #authBar { background: rgba(30,21,64,0.8); }
    #authBar button { background: var(--card); border: 1px solid var(--border); color: var(--lavender); border-radius: 8px; padding: 6px 14px; font-size: 13px; font-family: 'Noto Sans KR', sans-serif; cursor: pointer; }
    #authBar button:hover { border-color: var(--lavender); }
    #userLabel { font-size: 12px; color: var(--text3); }

    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    @media (min-width: 480px) {
      #app { max-width: 480px; margin: 0 auto; }
    }
  </style>
</head>
<body>
  <div id="authBar" style="display:flex;gap:8px;align-items:center;padding:12px 16px;">
    <button id="loginBtn">Googleë¡œ ë¡œê·¸ì¸</button>
    <button id="logoutBtn" style="display:none;">ë¡œê·¸ì•„ì›ƒ</button>
    <span id="userLabel" style="opacity:.9;"></span>
  </div>

  <div class="stars"></div>

  <div id="app">
    <div class="header">
      <div class="logo">ë¯¸ë˜ì €ë„ âœ¦</div>
      <div class="logo-sub">AIëŠ” ë„êµ¬ë‹¤. ë‚˜ëŠ” ë°©í–¥ì´ë‹¤.</div>
      <div class="streak-badge">
        <span>ğŸ”¥</span>
        <span id="streak-text">0ì¼ ì—°ì† ì‘ì„± ì¤‘</span>
      </div>
    </div>

    <!-- TODAY PAGE -->
    <div id="page-today" class="page active">
      <div class="date-label" id="today-date"></div>
      <div class="greeting">ì˜¤ëŠ˜ë„ ë‚˜ë¥¼ í–¥í•œ ì—¬ì •ì„ ì‹œì‘í•´ìš”</div>
      <div class="greeting-sub">6ê°€ì§€ ì§ˆë¬¸ì— ë‹µí•˜ë©° ë‚˜ë§Œì˜ ì¤‘ì‹¬ì„ í›ˆë ¨í•˜ì„¸ìš”</div>

      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill" style="width:0%"></div>
      </div>

      <div class="completion-banner" id="completion-banner">
        <h3>âœ¦ ì˜¤ëŠ˜ì˜ ì €ë„ ì™„ì„±!</h3>
        <p>ë§¤ì¼ ìŒ“ì´ëŠ” ê¸°ë¡ì´ ë‚˜ë§Œì˜ ì„±ì¥ ì§€ë„ê°€ ë©ë‹ˆë‹¤</p>
      </div>

      <div id="questions-container"></div>
      <button class="save-btn" onclick="saveToday()">ì˜¤ëŠ˜ì˜ ì €ë„ ì €ì¥í•˜ê¸°</button>
    </div>

    <!-- INSIGHT PAGE -->
    <div id="page-insight" class="page">
      <br>
      <div class="section-title">ğŸ“Š ë‚˜ì˜ ì„±ì¥ ì´ì•¼ê¸°</div>

      <div class="stats-row">
        <div class="stat-card">
          <div class="stat-num" id="total-days">0</div>
          <div class="stat-label">ì´ ì‘ì„±ì¼</div>
        </div>
        <div class="stat-card">
          <div class="stat-num" id="streak-num">0</div>
          <div class="stat-label">ì—°ì† ì‘ì„±</div>
        </div>
      </div>

      <div class="insight-card">
        <h3>âœ¨ ë‚˜ì— ëŒ€í•œ ì´ì•¼ê¸°</h3>
        <div class="insight-story" id="insight-story">
          ì €ë„ì„ ì‘ì„±í•˜ë©´ ë‹¹ì‹ ì— ëŒ€í•œ ì´ì•¼ê¸°ê°€ ìŒ“ì´ê¸° ì‹œì‘í•´ìš”.
        </div>
      </div>

      <div class="insight-card">
        <h3>ğŸ“… ì´ë²ˆ ë‹¬ ê¸°ë¡</h3>
        <div class="cal-grid" id="cal-grid"></div>
      </div>

      <div class="insight-card">
        <h3>ğŸ”‘ ë‚˜ì˜ í•µì‹¬ í‚¤ì›Œë“œ</h3>
        <div id="keywords" style="display:flex;flex-wrap:wrap;gap:8px;min-height:40px;">
          <span style="color:var(--text3);font-size:13px;">ì €ë„ì„ ì‘ì„±í•˜ë©´ í‚¤ì›Œë“œê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤</span>
        </div>
      </div>
    </div>

    <!-- HISTORY PAGE -->
    <div id="page-history" class="page">
      <br>
      <div class="section-title">ğŸ“– ì§€ë‚œ ê¸°ë¡</div>
      <div id="history-list">
        <div style="text-align:center;color:var(--text3);padding:40px 0;font-size:14px;">
          ì•„ì§ ì €ì¥ëœ ê¸°ë¡ì´ ì—†ì–´ìš”<br>
          <span style="font-size:12px;margin-top:8px;display:block">ì˜¤ëŠ˜ì˜ ì €ë„ì„ ì‘ì„±í•´ë³´ì„¸ìš”!</span>
        </div>
      </div>
    </div>

    <!-- AI PAGE -->
    <div id="page-ai" class="page">
      <br>
      <div class="section-title">ğŸ¤– AI ë™ë°˜ì ìƒë‹´</div>
      <div class="ai-chat" id="ai-chat">
        <div class="ai-msg-label">
          <span style="width:20px;height:20px;background:linear-gradient(135deg,var(--purple),var(--indigo));border-radius:50%;display:inline-block"></span>
          ë¯¸ë˜ì €ë„ AI
        </div>
        <div class="ai-msg">
          ì•ˆë…•í•˜ì„¸ìš” ğŸ˜Š ì €ëŠ” ë‹¹ì‹ ì˜ ì €ë„ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ëŒ€í™”í•˜ëŠ” AI ë™ë°˜ìì˜ˆìš”.<br><br>
          ì¼ë°˜ AIëŠ” ì§€ê¸ˆ ë§í•œ ê²ƒë§Œ ì•Œì§€ë§Œ, ì €ëŠ” <strong>ë‹¹ì‹ ì˜ ëˆ„ì  ê¸°ë¡</strong>ì„ ë°”íƒ•ìœ¼ë¡œ ë” ê¹Šì€ ëŒ€í™”ë¥¼ ë‚˜ëˆŒ ìˆ˜ ìˆì–´ìš”.<br><br>
          ì˜¤ëŠ˜ ì–´ë–¤ ê²ƒì´ ë§ˆìŒì— ê±¸ë¦¬ë‚˜ìš”?
        </div>
        <div id="ai-messages"></div>
      </div>
      <div class="ai-input-row">
        <input class="ai-input" id="ai-input" placeholder="AI ë™ë°˜ìì—ê²Œ ë§í•´ë³´ì„¸ìš”..." onkeydown="if(event.key==='Enter')sendAI()" />
        <button class="ai-send" onclick="sendAI()">â†‘</button>
      </div>
      <div style="font-size:11px;color:var(--text3);text-align:center;margin-top:10px">
        ì €ë„ì„ ë§ì´ ìŒ“ì„ìˆ˜ë¡ ë” ê¹Šì€ ëŒ€í™”ê°€ ê°€ëŠ¥í•´ìš”
      </div>
    </div>
  </div>

  <!-- Bottom Nav -->
  <nav class="nav">
    <button class="nav-btn active" onclick="showPage('today',this)">
      <svg fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
      ì˜¤ëŠ˜
    </button>
    <button class="nav-btn" onclick="showPage('insight',this)">
      <svg fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>
      ì¸ì‚¬ì´íŠ¸
    </button>
    <button class="nav-btn" onclick="showPage('history',this)">
      <svg fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>
      ê¸°ë¡
    </button>
    <button class="nav-btn" onclick="showPage('ai',this)">
      <svg fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 8v4M12 16h.01"/></svg>
      AIìƒë‹´
    </button>
  </nav>

  <div class="toast" id="toast"></div>

  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
  <script>
  // ====== FIREBASE ì´ˆê¸°í™” (ì™„ì„±ëœ config) ======
  const firebaseConfig = {
    apiKey: "AIzaSyCghP_tQelW2TFDmWdEnOCY-t8ogoKvL04",
    authDomain: "mirae-journal.firebaseapp.com",
    projectId: "mirae-journal",
    storageBucket: "mirae-journal.firebasestorage.app",
    messagingSenderId: "1062764613182",
    appId: "1:1062764613182:web:f372fc7cf16b1661ce4b6f",
    measurementId: "G-L4GV33S898"
  };

  try {
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    console.log("âœ… Firebase ì´ˆê¸°í™” ì„±ê³µ");
  } catch (e) {
    console.error("Firebase ì´ˆê¸°í™” ì‹¤íŒ¨", e);
  }

  const auth = firebase.auth();
  const db = firebase.firestore();

  // ====== AUTH ======
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const userLabel = document.getElementById("userLabel");
  let currentUser = null;

  loginBtn.addEventListener("click", async () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    try {
      await auth.signInWithPopup(provider);
    } catch(e) {
      console.error("ë¡œê·¸ì¸ ì‹¤íŒ¨", e);
      showToast("ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆì–´ìš”. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
    }
  });

  logoutBtn.addEventListener("click", async () => {
    await auth.signOut();
  });

  auth.onAuthStateChanged((user) => {
    currentUser = user;
    if (user) {
      loginBtn.style.display = "none";
      logoutBtn.style.display = "inline-block";
      userLabel.textContent = user.displayName || user.email || "User";
      loadData();
    } else {
      loginBtn.style.display = "inline-block";
      logoutBtn.style.display = "none";
      userLabel.textContent = "";
      resetUI();
    }
  });

  // ====== ì§ˆë¬¸ ëª©ë¡ â€” ê°ì‚¬ê°€ ë°˜ë“œì‹œ ì²« ë²ˆì§¸ ======
  const QUESTIONS = [
    { emoji: "ğŸŒ¸", category: "ê°ì‚¬", text: "ì˜¤ëŠ˜ ê°ì‚¬í•œ ê²ƒ 3ê°€ì§€ë¥¼ ì ì–´ë³´ì„¸ìš”. ë‹¹ì—°í•˜ê²Œ ì—¬ê²¼ë˜ ê²ƒë„ ì¢‹ì•„ìš”." },
    { emoji: "ğŸ§ ", category: "ë©”íƒ€ì¸ì§€", text: "ì§€ê¸ˆ ë‚´ ìƒê° ì¤‘ ê°€ì¥ ê°•í•˜ê²Œ ë¯¿ê³  ìˆëŠ” ê²ƒì€ ë¬´ì—‡ì¸ê°€ìš”? ê·¸ê²Œ ì •ë§ ì‚¬ì‹¤ì¸ê°€ìš”?" },
    { emoji: "ğŸ¤", category: "ê´€ê³„Â·ê²½ì²­", text: "ì˜¤ëŠ˜ ëˆ„êµ°ê°€ì˜ ë§ì„ ì§„ì‹¬ìœ¼ë¡œ ë“¤ì€ ìˆœê°„ì´ ìˆì—ˆë‚˜ìš”?" },
    { emoji: "ğŸ”‹", category: "ì—ë„ˆì§€", text: "ì§€ê¸ˆ ë‚˜ë¥¼ ì±„ì›Œì£¼ëŠ” ê²ƒê³¼ ë¹¼ì•—ëŠ” ê²ƒì€ ë¬´ì—‡ì¸ê°€ìš”?" },
    { emoji: "ğŸŒ±", category: "ì„±ì¥ ì˜ë„", text: "í•œ ë‹¬ ë’¤ì˜ ë‚˜ì—ê²Œ ì˜¤ëŠ˜ ë¬´ì—‡ì„ ì„ ë¬¼í•˜ê³  ì‹¶ë‚˜ìš”?" },
    { emoji: "ğŸ’¡", category: "í†µì°°", text: "ì˜¤ëŠ˜ ë˜ëŠ” ìµœê·¼, ìƒˆë¡­ê²Œ ê¹¨ë‹¬ì€ ê²ƒì´ ìˆë‹¤ë©´ ë¬´ì—‡ì¸ê°€ìš”?" },
  ];

  // ====== ì•± ìƒíƒœ ======
  let todayAnswers = {};
  let allEntries = {};

  // ====== ì´ˆê¸°í™” ======
  function init() {
    setTodayDate();
    renderQuestions();
    loadLocalData();
  }

  function setTodayDate() {
    const now = new Date();
    const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
    document.getElementById("today-date").textContent = now.toLocaleDateString('ko-KR', options);
  }

  function resetUI() {
    document.getElementById("streak-text").textContent = "0ì¼ ì—°ì† ì‘ì„± ì¤‘";
    document.getElementById("streak-num").textContent = "0";
    document.getElementById("total-days").textContent = "0";
    document.getElementById("insight-story").textContent = "ë¡œê·¸ì¸í•˜ë©´ ë‚˜ì— ëŒ€í•œ ì´ì•¼ê¸°ê°€ ìŒ“ì´ê¸° ì‹œì‘í•´ìš”.";
    document.getElementById("history-list").innerHTML = `
      <div style="text-align:center;color:var(--text3);padding:40px 0;font-size:14px;">
        ë¡œê·¸ì¸í•˜ë©´ ê¸°ë¡ì´ ì €ì¥ë©ë‹ˆë‹¤
      </div>`;
    allEntries = {};
  }

  // ====== ì§ˆë¬¸ ë Œë”ë§ ======
  function renderQuestions() {
    const container = document.getElementById("questions-container");
    container.innerHTML = "";

    QUESTIONS.forEach((q, i) => {
      const saved = todayAnswers[i] || "";
      const card = document.createElement("div");
      card.className = "question-card" + (saved ? " answered" : "");
      card.innerHTML = `
        <div class="q-header">
          <span class="q-emoji">${q.emoji}</span>
          <div class="q-meta">
            <div class="q-category">${q.category}</div>
            <div class="q-text">${q.text}</div>
          </div>
          <div class="q-check ${saved ? 'visible' : ''}" id="check-${i}">
            <svg fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7"/></svg>
          </div>
        </div>
        <textarea id="answer-${i}" placeholder="ììœ ë¡­ê²Œ ì ì–´ë³´ì„¸ìš”..." rows="3">${saved}</textarea>
        <button class="mic-btn" onclick="toggleMic(${i})" id="mic-${i}">
          ğŸ™ ìŒì„±ìœ¼ë¡œ ì…ë ¥
        </button>
      `;
      container.appendChild(card);

      const ta = card.querySelector(`#answer-${i}`);
      ta.addEventListener("input", () => {
        todayAnswers[i] = ta.value;
        const hasVal = ta.value.trim().length > 0;
        card.classList.toggle("answered", hasVal);
        document.getElementById(`check-${i}`).classList.toggle("visible", hasVal);
        updateProgress();
        saveLocalData();
      });
    });

    updateProgress();
  }

  function updateProgress() {
    const answered = QUESTIONS.filter((_, i) => todayAnswers[i] && todayAnswers[i].trim()).length;
    const pct = (answered / QUESTIONS.length) * 100;
    document.getElementById("progress-fill").style.width = pct + "%";
    document.getElementById("completion-banner").classList.toggle("show", answered === QUESTIONS.length);
  }

  // ====== ì €ì¥ ======
  function getTodayKey() {
    const now = new Date();
    return `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
  }

  function saveLocalData() {
    const todayKey = getTodayKey();
    const data = JSON.parse(localStorage.getItem("mirae_today") || "{}");
    data[todayKey] = todayAnswers;
    localStorage.setItem("mirae_today", JSON.stringify(data));
  }

  function loadLocalData() {
    const todayKey = getTodayKey();
    const data = JSON.parse(localStorage.getItem("mirae_today") || "{}");
    if (data[todayKey]) {
      todayAnswers = data[todayKey];
      renderQuestions();
    }
  }

  async function saveToday() {
    const answered = QUESTIONS.filter((_, i) => todayAnswers[i] && todayAnswers[i].trim()).length;
    if (answered === 0) {
      showToast("ìµœì†Œ í•œ ê°€ì§€ ì§ˆë¬¸ì— ë‹µí•´ì£¼ì„¸ìš” ğŸ™");
      return;
    }

    const todayKey = getTodayKey();
    const entry = {
      date: todayKey,
      answers: todayAnswers,
      savedAt: new Date().toISOString(),
      answeredCount: answered
    };

    // ë¡œì»¬ ì €ì¥
    allEntries[todayKey] = entry;
    localStorage.setItem("mirae_entries", JSON.stringify(allEntries));
    saveLocalData();

    // Firebase ì €ì¥
    if (currentUser) {
      try {
        await db.collection("users").doc(currentUser.uid)
          .collection("entries").doc(todayKey).set(entry);
        showToast("â˜ï¸ ì €ì¥ëì–´ìš”! ì˜¤ëŠ˜ì˜ ê¸°ë¡ì´ ìŒ“ì˜€ì–´ìš” âœ¦");
        console.log("âœ… Firestore ì €ì¥ ì„±ê³µ:", todayKey);
      } catch(e) {
        console.error("Firebase ì €ì¥ ì‹¤íŒ¨", e);
        showToast("ë¡œì»¬ ì €ì¥ ì™„ë£Œ (Firebase ì˜¤ë¥˜: " + e.code + ")");
      }
    } else {
      showToast("ë¡œì»¬ì— ì €ì¥ëì–´ìš” âœ“ (ë¡œê·¸ì¸í•˜ë©´ í´ë¼ìš°ë“œ ì €ì¥)");
    }

    updateStats();
    renderHistory();
    renderInsight();
  }

  // ====== ë°ì´í„° ë¡œë“œ ======
  async function loadData() {
    const local = JSON.parse(localStorage.getItem("mirae_entries") || "{}");
    allEntries = local;

    if (currentUser) {
      try {
        const snap = await db.collection("users").doc(currentUser.uid)
          .collection("entries").orderBy("date", "desc").limit(100).get();
        snap.forEach(doc => {
          allEntries[doc.id] = doc.data();
        });
        localStorage.setItem("mirae_entries", JSON.stringify(allEntries));
        console.log("âœ… Firebase ë¡œë“œ ì„±ê³µ, ì´", snap.size, "ê°œ");
      } catch(e) {
        console.error("Firebase ë¡œë“œ ì‹¤íŒ¨", e);
      }
    }

    updateStats();
    renderHistory();
    renderInsight();
  }

  // ====== í†µê³„ + ì´ì•¼ê¸°í˜• ì¸ì‚¬ì´íŠ¸ ======
  function updateStats() {
    const keys = Object.keys(allEntries).sort();
    const total = keys.length;
    document.getElementById("total-days").textContent = total;

    let streak = 0;
    const today = new Date();
    for (let i = 0; i < 365; i++) {
      const d = new Date(today);
      d.setDate(d.getDate() - i);
      const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
      if (allEntries[key]) streak++;
      else if (i > 0) break;
    }

    document.getElementById("streak-num").textContent = streak;
    document.getElementById("streak-text").textContent = `${streak}ì¼ ì—°ì† ì‘ì„± ì¤‘`;

    generateStory(total, streak, keys);
  }

  function generateStory(total, streak, keys) {
    const storyEl = document.getElementById("insight-story");
    if (total === 0) {
      storyEl.innerHTML = "ì €ë„ì„ ì‘ì„±í•˜ë©´ ë‹¹ì‹ ì— ëŒ€í•œ ì´ì•¼ê¸°ê°€ ìŒ“ì´ê¸° ì‹œì‘í•´ìš”.";
      return;
    }

    // ê°€ì¥ ë§ì´ ë‹µí•œ ì¹´í…Œê³ ë¦¬
    const catCount = {};
    Object.values(allEntries).forEach(entry => {
      Object.entries(entry.answers || {}).forEach(([idx, ans]) => {
        if (ans && ans.trim()) {
          const cat = QUESTIONS[idx]?.category || "";
          catCount[cat] = (catCount[cat] || 0) + 1;
        }
      });
    });
    const topCat = Object.entries(catCount).sort((a,b) => b[1]-a[1])[0];

    let story = "";
    if (total === 1) {
      story = `<strong>ì²« ë²ˆì§¸ ì €ë„</strong>ì„ ì™„ì„±í–ˆì–´ìš”. ì´ í•œ ê±¸ìŒì´ ë‚˜ë¥¼ í–¥í•œ ì—¬ì •ì˜ ì‹œì‘ì´ì—ìš”.`;
    } else if (total < 7) {
      story = `ì§€ë‚œ <strong>${total}ì¼</strong> ë™ì•ˆ ìŠ¤ìŠ¤ë¡œì—ê²Œ ì§ˆë¬¸í•˜ê³  ìˆì–´ìš”. ì´ë¯¸ ë§ì€ ì‚¬ëŒë“¤ì´ í•˜ì§€ ëª»í•˜ëŠ” ì¼ì„ í•˜ê³  ìˆì–´ìš”.`;
    } else if (total < 30) {
      story = `<strong>${total}ì¼</strong>ì˜ ê¸°ë¡ì´ ìŒ“ì˜€ì–´ìš”. ë§¤ì¼ ìì‹ ì—ê²Œ ì§ˆë¬¸í•˜ëŠ” ì‚¬ëŒì€ ë§ì§€ ì•Šì•„ìš” â€” ë‹¹ì‹ ì€ ê·¸ ê¸¸ì„ ê±·ê³  ìˆì–´ìš”.`;
    } else {
      story = `<strong>${total}ì¼</strong>ì˜ ê¸°ë¡ì´ ë‹¹ì‹ ë§Œì˜ ì„±ì¥ ì§€ë„ê°€ ë˜ê³  ìˆì–´ìš”. ì´ ë°ì´í„°ëŠ” MBTIê°€ ì ˆëŒ€ ì¤„ ìˆ˜ ì—†ëŠ” ì‚´ì•„ìˆëŠ” ìê¸°ì´í•´ì˜ˆìš”.`;
    }

    if (topCat) {
      story += `<br><br>íŠ¹íˆ <strong>${topCat[0]}</strong>ì— ëŒ€í•œ ì´ì•¼ê¸°ë¥¼ ê°€ì¥ ë§ì´ í–ˆì–´ìš”.`;
    }

    if (streak >= 3) {
      story += `<br><br>ğŸ”¥ <strong>${streak}ì¼ ì—°ì†</strong> ì‘ì„± ì¤‘ì´ì—ìš”. ì´ ìŠµê´€ì´ ì¡°ìš©íˆ ë‚˜ë¥¼ ë°”ê¾¸ê³  ìˆì–´ìš”.`;
    }

    storyEl.innerHTML = story;
  }

  // ====== íˆìŠ¤í† ë¦¬ ======
  function renderHistory() {
    const container = document.getElementById("history-list");
    const keys = Object.keys(allEntries).sort().reverse();

    if (keys.length === 0) {
      container.innerHTML = `<div style="text-align:center;color:var(--text3);padding:40px 0;font-size:14px;">ì•„ì§ ì €ì¥ëœ ê¸°ë¡ì´ ì—†ì–´ìš”<br><span style="font-size:12px;margin-top:8px;display:block">ì˜¤ëŠ˜ì˜ ì €ë„ì„ ì‘ì„±í•´ë³´ì„¸ìš”!</span></div>`;
      return;
    }

    container.innerHTML = keys.map(key => {
      const entry = allEntries[key];
      const answers = entry.answers || {};
      const firstAnswered = QUESTIONS.findIndex((_, i) => answers[i] && answers[i].trim());

      return `
        <div class="history-item">
          <div class="history-date">${formatDate(key)} Â· ${entry.answeredCount || 0}ê°œ ë‹µë³€</div>
          ${firstAnswered >= 0 ? `
            <div class="history-q">${QUESTIONS[firstAnswered].emoji} ${QUESTIONS[firstAnswered].text}</div>
            <div class="history-a history-preview">${answers[firstAnswered]}</div>
          ` : ''}
        </div>
      `;
    }).join("");
  }

  function formatDate(key) {
    const [y, m, d] = key.split("-");
    const date = new Date(y, m-1, d);
    return date.toLocaleDateString('ko-KR', { month: 'long', day: 'numeric', weekday: 'short' });
  }

  // ====== ì¸ì‚¬ì´íŠ¸ ======
  function renderInsight() {
    renderCalendar();
    renderKeywords();
  }

  function renderCalendar() {
    const now = new Date();
    const year = now.getFullYear();
    const month = now.getMonth();
    const daysInMonth = new Date(year, month+1, 0).getDate();
    const firstDay = new Date(year, month, 1).getDay();
    const todayDate = now.getDate();

    const grid = document.getElementById("cal-grid");
    grid.innerHTML = "";

    for (let i = 0; i < firstDay; i++) {
      const el = document.createElement("div");
      el.className = "cal-day";
      grid.appendChild(el);
    }

    for (let d = 1; d <= daysInMonth; d++) {
      const key = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      const hasEntry = !!allEntries[key];
      const isToday = d === todayDate;
      const el = document.createElement("div");
      el.className = "cal-day" + (hasEntry ? " has-entry" : "") + (isToday ? " today" : "");
      el.textContent = hasEntry ? "âœ¦" : d;
      grid.appendChild(el);
    }
  }

  function renderKeywords() {
    const allText = Object.values(allEntries).map(e => {
      return Object.values(e.answers || {}).join(" ");
    }).join(" ");

    if (!allText.trim()) return;

    const words = allText.split(/[\s,ã€‚ã€.!?]+/).filter(w => w.length > 1);
    const freq = {};
    const stopwords = new Set(["ë‚˜ëŠ”","ë‚˜ì˜","ë‚´ê°€","ê·¸ë¦¬ê³ ","í•˜ì§€ë§Œ","ê²ƒì´","ê²ƒì„","ìˆëŠ”","ìˆì–´","ì´ë‹¤","ì—ì„œ","í•˜ê³ ","ìœ¼ë¡œ","ì—ê²Œ","ë¶€í„°","ê¹Œì§€","ë•Œë¬¸","ì´ëŸ°","ê·¸ëŸ°","ì–´ë–¤","ëª¨ë“ ","ê°™ì€","ë”ìš±","ì˜¤ëŠ˜","ì–´ì œ","ë‚´ì¼","ì •ë§","ì•„ì£¼","ë§¤ìš°","ì¡°ê¸ˆ","ë§ì´","í•­ìƒ","ë•Œë¡œ","ìˆ˜ë„","ì—†ëŠ”","í•˜ëŠ”","ë˜ëŠ”","ë˜ì–´","í–ˆë‹¤","í•œë‹¤","í• ìˆ˜","ì´ê²ƒ","ì €ê²ƒ","ê·¸ê²ƒ","ìœ„í•´"]);
    words.forEach(w => {
      if (!stopwords.has(w)) freq[w] = (freq[w] || 0) + 1;
    });

    const sorted = Object.entries(freq).sort((a,b) => b[1]-a[1]).slice(0, 10);
    const container = document.getElementById("keywords");

    if (sorted.length === 0) {
      container.innerHTML = `<span style="color:var(--text3);font-size:13px;">ì €ë„ì„ ì‘ì„±í•˜ë©´ í‚¤ì›Œë“œê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤</span>`;
      return;
    }

    container.innerHTML = sorted.map(([word, count]) => `
      <span style="background:rgba(124,58,237,0.2);border:1px solid var(--border);border-radius:20px;padding:4px 12px;font-size:13px;color:var(--lavender);">
        ${word} <span style="opacity:0.6;font-size:11px;">${count}</span>
      </span>
    `).join("");
  }

  // ====== í˜ì´ì§€ ì „í™˜ ======
  function showPage(name, btn) {
    document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
    document.querySelectorAll(".nav-btn").forEach(b => b.classList.remove("active"));
    document.getElementById("page-" + name).classList.add("active");
    btn.classList.add("active");
    if (name === "insight") renderInsight();
    if (name === "history") renderHistory();
  }

  // ====== AI ìƒë‹´ ======
  function sendAI() {
    const input = document.getElementById("ai-input");
    const msg = input.value.trim();
    if (!msg) return;

    const msgContainer = document.getElementById("ai-messages");
    msgContainer.innerHTML += `<div class="user-msg">${msg}</div>`;
    input.value = "";

    setTimeout(() => {
      const totalEntries = Object.keys(allEntries).length;
      let reply = "";

      if (totalEntries === 0) {
        reply = "ì•„ì§ ì €ë„ì´ ì—†ë„¤ìš”. ì˜¤ëŠ˜ ì²« ì €ë„ì„ ì‘ì„±í•´ë³´ë©´ ì œê°€ ë” ê¹Šì€ ì´ì•¼ê¸°ë¥¼ ë‚˜ëˆŒ ìˆ˜ ìˆì–´ìš” ğŸ˜Š";
      } else {
        const responses = [
          `${totalEntries}ì¼ ê°„ì˜ ê¸°ë¡ì„ ë³´ë©´, ë‹¹ì‹ ì€ ê¾¸ì¤€íˆ ìì‹ ì„ ëŒì•„ë³´ê³  ìˆì–´ìš”. ê·¸ ìì²´ê°€ ì´ë¯¸ ë‚˜ë§Œì˜ ì¤‘ì‹¬ì„ ë§Œë“œëŠ” í›ˆë ¨ì´ì—ìš”.`,
          "ë‹¹ì‹ ì˜ ì§ˆë¬¸ì—ì„œ ì„±ì¥í•˜ë ¤ëŠ” ì˜ì§€ê°€ ëŠê»´ì ¸ìš”. ì¡°ê¸ˆ ë” êµ¬ì²´ì ìœ¼ë¡œ ë§í•´ì¤„ ìˆ˜ ìˆì–´ìš”?",
          "ì €ë„ì—ì„œ ë°˜ë³µì ìœ¼ë¡œ ë‚˜íƒ€ë‚˜ëŠ” íŒ¨í„´ì´ ìˆì–´ìš”. ë¬´ì—‡ì´ ë‹¹ì‹ ì—ê²Œ ì—ë„ˆì§€ë¥¼ ì£¼ëŠ”ì§€ ìƒê°í•´ë³´ì…¨ë‚˜ìš”?",
          "ì¢‹ì€ ì§ˆë¬¸ì´ì—ìš”. ê³¼ê±°ì˜ ê¸°ë¡ì„ ë³´ë©´, ë‹¹ì‹ ì€ ì´ëŸ° ê³ ë¯¼ì„ ì „ì—ë„ í•´ê²°í–ˆì–´ìš”. ê·¸ë•Œ ì–´ë–»ê²Œ í–ˆëŠ”ì§€ ê¸°ì–µí•˜ì‹œë‚˜ìš”?",
        ];
        reply = responses[Math.floor(Math.random() * responses.length)];
      }

      msgContainer.innerHTML += `
        <div class="ai-msg-label">
          <span style="width:16px;height:16px;background:linear-gradient(135deg,var(--purple),var(--indigo));border-radius:50%;display:inline-block"></span>
          ë¯¸ë˜ì €ë„ AI
        </div>
        <div class="ai-msg">${reply}</div>
      `;
      document.getElementById("ai-chat").scrollTop = document.getElementById("ai-chat").scrollHeight;
    }, 600);
  }

  // ====== ìŒì„± ì…ë ¥ ======
  let recognition = null;
  let activeRecMic = null;

  function toggleMic(qIndex) {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
      showToast("ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì…ë ¥ì„ ì§€ì›í•˜ì§€ ì•Šì•„ìš”");
      return;
    }

    const btn = document.getElementById(`mic-${qIndex}`);
    const ta = document.getElementById(`answer-${qIndex}`);

    if (recognition && activeRecMic === qIndex) { recognition.stop(); return; }
    if (recognition) recognition.stop();

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.lang = "ko-KR";
    recognition.continuous = false;
    recognition.interimResults = false;
    activeRecMic = qIndex;

    btn.classList.add("recording");
    btn.textContent = "ğŸ”´ ë…¹ìŒ ì¤‘... (í´ë¦­í•˜ì—¬ ì¤‘ì§€)";

    recognition.onresult = (e) => {
      const transcript = e.results[0][0].transcript;
      ta.value = (ta.value ? ta.value + " " : "") + transcript;
      todayAnswers[qIndex] = ta.value;
      ta.dispatchEvent(new Event("input"));
    };

    recognition.onend = () => {
      btn.classList.remove("recording");
      btn.innerHTML = "ğŸ™ ìŒì„±ìœ¼ë¡œ ì…ë ¥";
      activeRecMic = null; recognition = null;
    };

    recognition.onerror = (e) => {
      console.error("ìŒì„±ì¸ì‹ ì˜¤ë¥˜", e);
      btn.classList.remove("recording");
      btn.innerHTML = "ğŸ™ ìŒì„±ìœ¼ë¡œ ì…ë ¥";
      activeRecMic = null; recognition = null;
    };

    recognition.start();
  }

  // ====== í† ìŠ¤íŠ¸ ======
  function showToast(msg) {
    const toast = document.getElementById("toast");
    toast.textContent = msg;
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 3000);
  }

  // ====== ì‹œì‘ ======
  init();
  </script>
</body>
</html>
